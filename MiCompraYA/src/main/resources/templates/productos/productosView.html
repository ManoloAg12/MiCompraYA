<div th:fragment="content">
  <section class="container mx-auto px-6 py-6">
    <nav class="text-sm mb-4">
      <ol class="list-reset flex text-gray-500">
        <li><a th:href="@{/}" class="hover:text-green-600">Inicio</a></li>
        <li><span class="mx-2">/</span></li>
        <li class="text-green-600 font-semibold">Productos</li>
      </ol>
    </nav>

    <h1 class="text-3xl font-bold mb-2">Todos los Productos</h1>
    <p class="text-gray-600 mb-6">Encuentra los mejores productos frescos y de calidad para tu hogar</p>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <aside class="bg-white shadow rounded-lg p-5 h-fit sticky top-10">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Filtros</h2>
          <a th:href="@{/producto}" class="text-green-600 text-sm hover:underline">Limpiar Todo</a>
        </div>

        <form th:action="@{/producto}" method="get" class="mb-5">
          <input type="hidden" name="categoriaId" th:value="${paramCategoriaId}">
          <input type="hidden" name="orden" th:value="${paramOrden}">

          <input type="text" name="busqueda" placeholder="Buscar productos..."
                 th:value="${paramBusqueda}"
                 class="w-full px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring focus:ring-green-300">
        </form>

        <div class="mb-5">
          <h3 class="text-md font-semibold mb-2">Categorías</h3>
          <ul class="space-y-2 text-sm">
            <li>
              <a th:href="@{/producto(busqueda=${paramBusqueda}, orden=${paramOrden})}"
                 class="hover:text-green-600"
                 th:classappend="${paramCategoriaId == null} ? 'font-bold text-green-700' : ''">
                Todas las Categorías (<span th:text="${conteoTotal}">0</span>)
              </a>
            </li>
            <li th:each="cat : ${categorias}">
              <a th:href="@{/producto(categoriaId=${cat.id}, busqueda=${paramBusqueda}, orden=${paramOrden})}"
                 class="hover:text-green-600"
                 th:classappend="${cat.id == paramCategoriaId} ? 'font-bold text-green-700' : ''">
                <span th:text="${cat.categoria}">Categoría</span>
                (<span th:text="${conteoCategorias[cat.id] ?: 0}">0</span>)
              </a>
            </li>
          </ul>
        </div>
      </aside>

      <div class="lg:col-span-3">
        <div class="flex justify-between items-center mb-5">
          <p class="text-sm text-gray-600">
            Mostrando <span class="font-semibold" th:text="${#lists.size(productos)}">0</span> productos
          </p>

          <div class="flex items-center space-x-3">
            <label class="text-sm">Ordenar por:</label>
            <form th:action="@{/producto}" method="get" id="sortForm">
              <input type="hidden" name="categoriaId" th:value="${paramCategoriaId}">
              <input type="hidden" name="busqueda" th:value="${paramBusqueda}">

              <select name="orden" onchange="document.getElementById('sortForm').submit();"
                      class="border rounded-lg px-2 py-1 text-sm focus:ring focus:ring-green-300">
                <option value="nombre-asc" th:selected="${paramOrden == 'nombre-asc'}">Nombre A-Z</option>
                <option value="nombre-desc" th:selected="${paramOrden == 'nombre-desc'}">Nombre Z-A</option>
                <option value="precio-asc" th:selected="${paramOrden == 'precio-asc'}">Precio Menor-Mayor</option>
                <option value="precio-desc" th:selected="${paramOrden == 'precio-desc'}">Precio Mayor-Menor</option>
              </select>
            </form>
          </div>
        </div>

        <div th:if="${#lists.isEmpty(productos)}" class="text-center text-gray-500 py-10">
          <i class="fa-solid fa-search text-3xl mb-3"></i>
          <p class="font-semibold">No se encontraron productos</p>
          <p class="text-sm">Intenta ajustar tus filtros de búsqueda.</p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
          <div th:each="p : ${productos}"
               class="bg-white border rounded-lg shadow hover:shadow-lg transform transition-transform duration-300 hover:scale-105 relative">

            <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500">

            </button>
            <span th:if="${p.stock <= 0}"
                  class="absolute top-0 left-0 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-br-lg z-10">
                AGOTADO
            </span>
            <img th:src="${p.urlImagen}" alt="Imagen del producto"
                 class="w-full h-48 object-contain p-4">
            <div class="p-4">
              <h3 class="text-sm text-gray-500" th:text="${p.categoria.categoria}">Categoría</h3>
              <p class="font-semibold" th:text="${p.nombre}">Nombre del producto</p>
              <p class="text-green-600 font-bold mt-2"
                 th:text="'$' + ${#numbers.formatDecimal(p.precio, 1, 2, 'POINT')}"></p>

              <th:block th:if="${p.stock > 0}">

                <button th:if="${session.usuario != null}" type="button"
                        class="agregar-carrito mt-3 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2"
                        th:attr="data-idproducto=${p.id}, data-stock=${p.stock}">
                  <i class="fa-solid fa-cart-plus"></i> Agregar al carrito
                </button>

                <a th:unless="${session.usuario != null}" th:href="@{/login}"
                   class="mt-3 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2 text-decoration-none">
                  <i class="fa-solid fa-cart-plus"></i> Agregar al carrito
                </a>

              </th:block>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</div>